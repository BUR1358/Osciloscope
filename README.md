# Osciloscope
Разработка устройства на основе микроконтроллера STM32F407VGT6 для ввода и отображения аналоговых сигналов. На два входа микроконтроллера подаются два различных аналоговых сигнала с генератора сигналов Rigol DG4162. Аналого-цифровой преобразователь микроконтроллера оцифровывает два получаемых сигнала и записывает в память. Отладочная плата с данным микроконтроллером имеет USB – интерфейс, через который осуществляется передача оцифрованных данных в персональный компьютер. Для персонального компьютера написана программа, для приема и визуализации получаемых с микроконтроллера данных.

![alt text](https://github.com/BUR1358/Osciloscope/blob/main/pic/%D1%81%D1%82%D1%80%D1%83%D0%BA%D1%82%D1%83%D1%80%D0%BD%D0%B0%D1%8F_%D1%81%D1%85%D0%B5%D0%BC%D0%B0.png "Структуная схема")

Для программирования данного микроконтроллера используется две среды разработки STM32CubeMX и Keil uVision.
Начальная конфигурация периферии микроконтроллера производится в конфигураторе STM32CubeMx. 
АЦП сконфигурирован так, чтобы он запускался по таймеру. Утсройство рассчитывалось на обработку сигнала с частотой не выше 5 кГц. Исходя из этого, по теореме Котельникова, частота дискретизации выбрана 10 кГц, то есть таймер запускает АЦП каждые 100 мкс. 
Так как используется только один АЦП и требуется получать сразу два сигнала, то используются 2 инжектированных канала АЦП. Происходит одновременная выборка, так как у каждого канала свое устройство выборки и хранения, а затем преобразование сначала одного значения, а затем другого. Таким образом, значения преобразуются последовательно, но выбираются эти значение единовременно. 
Опорное напряжение АЦП составляет 3 вольта. Диапазон напряжений, который способен воспринимать АЦП, составляет от 0 до 3 В. При подаче меньшего напряжения АЦП будет фиксировать свое минимальное значение - ноль. При подаче напряжения более 3 вольт АЦП будет фиксировать свое максимальное значение – 4095.
Для передачи полученных с АЦП значений в персональный компьютер, используется USB-интерфейс, который сконфигурирован в режим виртуального COM-порта. Особенность блока USB в том, что частота, которой он тактируется, обязательно должна быть равна 48 МГц. Если частота будет отличной от 48 МГц, то сторонние устройства на шине USB не поймут данное устройство, а устройство не сможет понять их. 
Отправка данных с АЦП в персональный компьютер происходит после нажатия на кнопку на плате. Окончание передачи происхолит после повторного нажатии. Во время передачи значений с АЦП должен горит светодиод, находящийся на отладочной плате.

Код программы написан в среде разработки Keil uVision на языке программирования C. Алгоритм программы показан на блок-схеме.

![alt text](https://github.com/BUR1358/Osciloscope/blob/main/pic/%D0%B1%D0%BB%D0%BE%D0%BA_%D1%81%D1%85%D0%B5%D0%BC%D0%B0_STM32.png "Блок-схема програмы для stm32")

АЦП фиксирует значения с первого и второго инжектированного канала в момент прерываний и заполняет ими два массива, для первого и второго канала соответственно. Так как передача по USB-интерфейсу осуществляется только 8-битными значениями, а значения с АЦП получены в виде 16-битных чисел, то каждый элемент двух массивов разбивается на старший и младший байты, которые являются 8-битными значениями. Таким образом, должно получится два массива, один из который содержит поочередно старшие и младшие байты значений с первого инжектированного канала, а второй старшие и младшие байты – со второго инжектированного канала.
Если была нажата кнопка, то, как только массивы будут заполнены и обработаны, будет произведена отправка в персональный компьютер по USB-интерфейсу сначала первого массива, затем второго. Массив передается единым пакетом. Для того, чтобы было возможно различить с какого канала получены значения, в первые два элемента массива установлены метки. Во время передачи горит светодиод.

![alt text](https://github.com/BUR1358/Osciloscope/blob/main/pic/%D0%B1%D0%BB%D0%BE%D0%BA_%D1%81%D1%85%D0%B5%D0%BC%D0%B0_%D0%BF%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D1%87%D0%B0.png "Структура передаваемого пакета")

Для написания программы, обрабатывающий и визуализирующий принимаемые данные, выбран язык программирования Python. Данный язык программирования был выбран из-за большого количества дополнительных расширений, для обработки и отображения данных.
В качестве среды разработки был выбран PyCharm Community Edition.
Для реализации программы использовались следующие расширения: Pyqtgraph – для построения графиков, Serial – для работы с COM-портами, NumPy – для работы с массивами, PySide2 – для создания интерфейса программы, Openpyxl – для сохранения значений в Microsoft Excel-таблицу и PyInstaller для сборки программы в готовый exe файл.
Алгоритм работы программы представлен на блок схеме.

![alt text](https://github.com/BUR1358/Osciloscope/blob/main/pic/%D0%B1%D0%BB%D0%BE%D0%BA_%D1%81%D1%85%D0%B5%D0%BC%D0%B0_python.png "Блок-схема программы для принятия пакета на Python")

Программа получает данные из виртуального COM-порта, который является USB-портом компьютера. Определяет, с какого канала АЦП был получен массив по первым двум элементам массива – меткам и объединяет старшие и младшие байты обратно в 16-битное значение, полученное с АЦП. Так как опорное напряжение АЦП равно 3 вольтам, а диапазон возможных значений АЦП равен от 0 до 4095, то для перевода значения в вольты, потребуется умножить его на 3 и разделить на 4096. Данная операция выполняется для каждого элемента полученного массива. 
В окне программы предусмотрен слайдер, которым устанавливается уровень синхронизации сигнала. Если уровень синхронизации равен нулю, то синхронизация отключена. Если он не равен нулю, то используется алгоритм, который синхронизирует полученный сигнал.
Также в программе предусмотрены функция сохранения полученного дискретизированного сигнала в Microsoft Excel – таблицу.

Окно готового приложения для визуализации получаемых сигналов.

![alt text](https://github.com/BUR1358/Osciloscope/blob/main/pic/%D0%BE%D0%BA%D0%BD%D0%BE_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D1%8B.png "окно программы")

За раз возможно передать по USB-интерфейсу до 2 Кбайт данных. Из этого следует, что за раз возможно отправить массив, состоящий из 2048 элементов. Но так как 16-битное значение с АЦП делится на два 8-битных (старший и младший байт этого значения), то за раз возможно осуществить передачу 1024 значений с АЦП. Первые два элемента массива используются для метки, поэтому за раз передается 1023 значения.
Устройство имеет частоту дискретизации равной 10 кГц и наиболее подходит для работы с сигналами, имеющими частоту от 9,78 Гц до 5 кГц. За один полный программный цикл, возможно осуществить отрисовку 102,3 мс.
Исходя из проведенного тестирования, сделан вывод, что устройство способно различимо отображать сигналы с амплитудой от 10 мВ до 3 В. При подаче сигнала с амплитудой менее 10 мВ сигнал теряется в шумах. Программа, разработанная для компьютера, позволяет отображать одновременно сразу два сигнала, имеет функционал, позволяющий выбрать необходимый COM-порт и скорость приема данных, синхронизировать сигнал, по заданному уровню, а также сохранить полученные данные в файл Microsoft Excel. Функционал библиотеки PyQtGraph позволяет сохранить график в виде изображения с расширениями PNG, TIF, JPG, SVG.

![alt text](https://github.com/BUR1358/Osciloscope/blob/main/pic/%D0%BF%D0%BE%D1%81%D1%82%D1%80%D0%BE%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D0%BA%D0%BE%D0%B2.png "Готовое устройство")
